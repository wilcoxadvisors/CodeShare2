Architect's Instruction for the Replit AI Agent
Status Review: The user has reported that they cannot switch between entities. The logs show a "state battle" where the application overwrites the user's selection.

Goal: Fix the state management logic to ensure a user's explicit entity selection from the GlobalContextSelector is always respected and is the single source of truth.

File to Modify: client/src/contexts/EntityContext.tsx

Action: You will modify the useEffect hook that handles client selection changes. You must disable the aggressive "auto-select" logic that is causing the bug.

Step 1: Locate the Flawed Logic

In client/src/contexts/EntityContext.tsx, find the useEffect hook that has [selectedClientId, entitiesData] in its dependency array. This hook is responsible for filtering entities when the client changes.
Inside this hook, you will find the logic that automatically selects the first entity in the list. It will look something like this:
TypeScript

if (filteredEntities.length > 0 && !currentEntity) {
  // This is the problematic auto-selection
  setCurrentEntity(filteredEntities[0]);
}
Step 2: Disable the Auto-Selection

You must remove or comment out this block of code. A user's selection should be intentional. If the client changes, the correct behavior is to clear the current entity and let the user (or the URL) decide the next one, not to guess for them.

Modify the useEffect to remove the auto-selection:

TypeScript

// Inside the useEffect in EntityContext.tsx
useEffect(() => {
    // ... (the existing logic to filter entities based on selectedClientId)

    // Find this block and REMOVE it:
    // if (filteredEntities.length > 0 && !currentEntity) {
    //   console.log("ARCHITECT_DEBUG_ENTITY_CTX_CLIENT_CHANGE: Auto-selecting first entity:", filteredEntities[0]);
    //   setCurrentEntity(filteredEntities[0]);
    // }

    // The hook should now only filter the list and not attempt to set the currentEntity.

}, [selectedClientId, entitiesData]);
Agent, this change will stop the component from fighting with itself. The user's selection in the dropdown will now be the final word, which will trigger the correct navigation and fix the bug.